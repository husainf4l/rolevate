<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CV Builder - Rolevate CV Builder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
    </style>
    <script>
        // Client-side authentication check and user loading
        (function() {
            const token = localStorage.getItem('access_token');
            if (!token) {
                window.location.href = '/auth/signin?next=/cvbuilder';
                return;
            }

            // Verify token with server
            fetch('/auth/me', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => {
                if (!response.ok) {
                    localStorage.removeItem('access_token');
                    localStorage.removeItem('refresh_token');
                    localStorage.removeItem('user');
                    window.location.href = '/auth/signin?next=/cvbuilder';
                }
                return response.json();
            })
            .then(user => {
                if (user) {
                    // Update all user name elements
                    document.querySelectorAll('.user-name').forEach(el => {
                        el.textContent = user.full_name || user.username || 'User';
                    });

                    // Update user initials
                    document.querySelectorAll('.user-initial').forEach(el => {
                        const name = user.full_name || user.username || 'U';
                        el.textContent = name.charAt(0).toUpperCase();
                    });

                    // Update user email
                    const emailEl = document.getElementById('userEmail');
                    if (emailEl) emailEl.textContent = user.email;

                    localStorage.setItem('user', JSON.stringify(user));
                }
            })
            .catch(error => {
                console.error('Error verifying authentication:', error);
                window.location.href = '/auth/signin?next=/cvbuilder';
            });
        })();

        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'apple-blue': '#007AFF',
                        'apple-gray': '#F5F5F7',
                        'apple-dark': '#1D1D1F',
                    },
                }
            }
        }
    </script>
</head>
<body class="h-full bg-apple-gray flex">

    <!-- Sidebar -->
    <aside id="sidebar" class="fixed inset-y-0 left-0 z-50 w-64 bg-white shadow-lg transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out">
        <div class="flex flex-col h-full">
            <!-- Logo -->
            <div class="flex items-center justify-center h-16 px-4 border-b border-gray-200">
                <a href="/dashboard" class="flex items-center space-x-2">
                    <div class="w-8 h-8 bg-black rounded-lg flex items-center justify-center">
                        <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6z"/>
                            <path d="M14 2v6h6M16 13H8M16 17H8M10 9H8"/>
                        </svg>
                    </div>
                    <span class="text-xl font-semibold text-gray-900">Rolevate</span>
                </a>
            </div>

            <!-- Navigation -->
            <nav class="flex-1 px-4 py-6 space-y-2">
                <a href="/dashboard" class="flex items-center px-4 py-3 text-sm font-medium text-gray-600 hover:text-gray-900 hover:bg-gray-50 rounded-xl transition-colors duration-200">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5a2 2 0 012-2h4a2 2 0 012 2v2H8V5z"/>
                    </svg>
                    Dashboard
                </a>
                <a href="/cvbuilder" class="flex items-center px-4 py-3 text-sm font-medium text-white bg-black rounded-xl transition-colors duration-200">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                    </svg>
                    CV Builder
                </a>
                <a href="/enhance" class="flex items-center px-4 py-3 text-sm font-medium text-gray-600 hover:text-gray-900 hover:bg-gray-50 rounded-xl transition-colors duration-200">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                    </svg>
                    Enhance CV
                </a>
            </nav>

            <!-- User Info -->
            <div class="px-4 py-4 border-t border-gray-200">
                <div class="flex items-center space-x-3 mb-3">
                    <div class="w-10 h-10 rounded-full bg-black flex items-center justify-center text-white text-sm font-semibold">
                        <span class="user-initial">U</span>
                    </div>
                    <div>
                        <div class="text-sm font-semibold text-gray-900 user-name">Loading...</div>
                        <div id="userEmail" class="text-xs text-gray-500">user@example.com</div>
                    </div>
                </div>
                <button onclick="logout()" class="w-full px-4 py-2 text-sm font-medium text-gray-600 hover:text-gray-900 hover:bg-gray-50 rounded-xl transition-colors duration-200">
                    Logout
                </button>
            </div>
        </div>
    </aside>

    <!-- Overlay for mobile -->
    <div id="sidebar-overlay" class="fixed inset-0 z-40 bg-black bg-opacity-50 md:hidden hidden" onclick="toggleSidebar()"></div>

    <!-- Main Content -->
    <div class="flex-1 md:ml-64">
        <!-- Top Bar for Mobile -->
        <div class="md:hidden bg-white border-b border-gray-200 px-4 py-3 flex items-center justify-between">
            <button onclick="toggleSidebar()" class="p-2 text-gray-600 hover:bg-gray-50 rounded-lg">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                </svg>
            </button>
            <span class="text-lg font-semibold text-gray-900">CV Builder</span>
            <div class="w-8"></div>
        </div>

        <div class="h-screen p-6">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 h-full">
            
            <!-- Chat Panel -->
            <div class="flex flex-col bg-white rounded-2xl shadow-sm overflow-hidden">
                <!-- Header -->
                <div class="px-6 py-4 border-b border-gray-100">
                    <div class="flex items-center justify-between">
                        <div>
                            <h1 class="text-xl font-semibold text-gray-900">CV Agent</h1>
                            <p class="text-xs text-gray-500 mt-0.5">AI-powered CV builder</p>
                        </div>
                        <div class="flex items-center gap-1.5 px-2.5 py-1 bg-green-50 rounded-full">
                            <div class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></div>
                            <span class="text-xs font-medium text-green-700">Online</span>
                        </div>
                    </div>
                </div>

                <!-- Messages -->
                <div id="chatMessages" class="flex-1 overflow-y-auto p-6 space-y-4">
                    <!-- Welcome -->
                    <div class="flex gap-3">
                        <div class="flex-shrink-0 w-7 h-7 rounded-full bg-apple-blue flex items-center justify-center text-white text-xs font-medium">
                            AI
                        </div>
                        <div class="flex-1 max-w-lg">
                            <div class="bg-gray-50 rounded-2xl rounded-tl-sm p-4">
                                <p class="text-sm font-medium text-gray-900 mb-2">Welcome to Rolevate</p>
                                <p class="text-sm text-gray-600 mb-3">I can help you create a professional CV:</p>
                                <div class="space-y-1.5 text-xs text-gray-600 mb-4">
                                    <div class="flex items-start gap-2">
                                        <span class="text-apple-blue mt-0.5">â€¢</span>
                                        <span>Extract data from existing CV</span>
                                    </div>
                                    <div class="flex items-start gap-2">
                                        <span class="text-apple-blue mt-0.5">â€¢</span>
                                        <span>Build new CV through conversation</span>
                                    </div>
                                    <div class="flex items-start gap-2">
                                        <span class="text-apple-blue mt-0.5">â€¢</span>
                                        <span>Generate professional templates</span>
                                    </div>
                                </div>
                                <div class="flex flex-wrap gap-2">
                                    <button onclick="selectOption('upload')" class="px-3 py-1.5 bg-apple-blue hover:bg-blue-600 text-white text-xs font-medium rounded-lg transition-colors duration-150">
                                        Upload CV
                                    </button>
                                    <button onclick="selectOption('build')" class="px-3 py-1.5 bg-gray-100 hover:bg-gray-200 text-gray-900 text-xs font-medium rounded-lg transition-colors duration-150">
                                        Build New
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="px-6 py-3 border-t border-gray-100">
                    <div class="flex flex-wrap gap-2">
                        <button onclick="quickAction('skills')" class="px-2.5 py-1 bg-gray-100 hover:bg-gray-200 text-gray-700 text-xs font-medium rounded-full transition-colors duration-150">
                            + Skills
                        </button>
                        <button onclick="quickAction('experience')" class="px-2.5 py-1 bg-gray-100 hover:bg-gray-200 text-gray-700 text-xs font-medium rounded-full transition-colors duration-150">
                            + Experience
                        </button>
                        <button onclick="quickAction('education')" class="px-2.5 py-1 bg-gray-100 hover:bg-gray-200 text-gray-700 text-xs font-medium rounded-full transition-colors duration-150">
                            + Education
                        </button>
                        <button onclick="quickAction('clear')" class="px-2.5 py-1 bg-gray-100 hover:bg-red-50 text-gray-700 hover:text-red-600 text-xs font-medium rounded-full transition-colors duration-150">
                            Clear
                        </button>
                    </div>
                </div>

                <!-- Upload Zone -->
                <div id="uploadZone" class="hidden mx-6 mb-4 border-2 border-dashed border-gray-200 rounded-xl p-6 text-center cursor-pointer hover:border-apple-blue hover:bg-blue-50/50 transition-all duration-200" onclick="document.getElementById('fileInput').click()">
                    <div class="text-2xl mb-2">ðŸ“„</div>
                    <p class="text-sm font-medium text-gray-700 mb-1">Drop CV or click to browse</p>
                    <p class="text-xs text-gray-500">PDF, DOCX, TXT, JSON (max 10MB)</p>
                    <input type="file" id="fileInput" accept=".pdf,.docx,.txt,.json" onchange="handleFileUpload(event)" class="hidden">
                </div>

                <!-- Input -->
                <div class="px-6 py-4 border-t border-gray-100">
                    <div class="flex gap-2">
                        <button onclick="toggleUpload()" class="flex-shrink-0 w-9 h-9 bg-gray-100 hover:bg-gray-200 rounded-lg flex items-center justify-center text-gray-600 transition-colors duration-150">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path>
                            </svg>
                        </button>
                        <input 
                            type="text" 
                            id="chatInput" 
                            placeholder="Type a message..."
                            class="flex-1 px-4 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-apple-blue focus:border-transparent"
                            onkeypress="handleKeyPress(event)"
                        >
                        <button onclick="sendMessage()" class="flex-shrink-0 px-4 py-2 bg-apple-blue hover:bg-blue-600 text-white text-sm font-medium rounded-lg transition-colors duration-150">
                            Send
                        </button>
                    </div>
                </div>
            </div>

            <!-- Preview Panel -->
            <div class="flex flex-col bg-white rounded-2xl shadow-sm overflow-hidden">
                <!-- Header -->
                <div class="px-6 py-4 border-b border-gray-100">
                    <h2 class="text-lg font-semibold text-gray-900 mb-3">Preview</h2>
                    <div class="flex flex-wrap gap-2">
                        <select id="templateSelect" onchange="updateTemplate()" class="px-3 py-1.5 bg-gray-50 border border-gray-200 text-gray-700 text-xs rounded-lg focus:outline-none focus:ring-2 focus:ring-apple-blue cursor-pointer">
                            <option value="modern_cv">Modern</option>
                            <option value="classic_cv">Classic</option>
                            <option value="executive_cv">Executive</option>
                        </select>
                        <button onclick="downloadCV('pdf')" class="px-3 py-1.5 bg-gray-50 hover:bg-gray-100 border border-gray-200 text-gray-700 text-xs font-medium rounded-lg transition-colors duration-150">
                            PDF
                        </button>
                        <button onclick="downloadCV('docx')" class="px-3 py-1.5 bg-gray-50 hover:bg-gray-100 border border-gray-200 text-gray-700 text-xs font-medium rounded-lg transition-colors duration-150">
                            DOCX
                        </button>
                    </div>
                </div>

                <!-- Content -->
                <div class="flex-1 overflow-y-auto p-6 bg-gray-50">
                    <div id="cvContent" class="bg-white rounded-xl shadow-sm p-8 min-h-full">
                        <!-- Empty State -->
                        <div class="flex flex-col items-center justify-center h-full text-center py-16">
                            <div class="w-14 h-14 bg-gray-100 rounded-xl flex items-center justify-center text-2xl mb-3">
                                ðŸ“‹
                            </div>
                            <h3 class="text-base font-semibold text-gray-900 mb-1">Your CV Preview</h3>
                            <p class="text-sm text-gray-500">Start building to see your CV here</p>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        let cvData = {
            contact_info: {},
            experiences: [],
            education: [],
            skills: [],
            summary: ''
        };

        let conversationState = 'initial';

        function addMessage(content, isUser = false, options = null) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex gap-3 ${isUser ? 'justify-end' : ''}`;
            
            const avatar = isUser 
                ? '<div class="flex-shrink-0 w-7 h-7 rounded-full bg-gray-200 flex items-center justify-center text-gray-700 text-xs font-medium">You</div>'
                : '<div class="flex-shrink-0 w-7 h-7 rounded-full bg-apple-blue flex items-center justify-center text-white text-xs font-medium">AI</div>';
            
            const bgClass = isUser 
                ? 'bg-apple-blue text-white' 
                : 'bg-gray-50';
            
            const textClass = isUser ? 'text-white' : 'text-gray-700';
            
            const optionsHtml = options 
                ? `<div class="flex flex-wrap gap-2 mt-3">${options.map(opt => 
                    `<button onclick="${opt.action}" class="px-3 py-1.5 bg-apple-blue hover:bg-blue-600 text-white text-xs font-medium rounded-lg transition-colors duration-150">${opt.label}</button>`
                  ).join('')}</div>` 
                : '';
            
            messageDiv.innerHTML = `
                ${!isUser ? avatar : ''}
                <div class="flex-1 ${isUser ? 'max-w-md' : 'max-w-lg'}">
                    <div class="${bgClass} ${isUser ? 'rounded-2xl rounded-tr-sm' : 'rounded-2xl rounded-tl-sm'} p-4">
                        <p class="${textClass} text-sm whitespace-pre-line">${content}</p>
                        ${optionsHtml}
                    </div>
                </div>
                ${isUser ? avatar : ''}
            `;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function showTyping() {
            const messagesContainer = document.getElementById('chatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'flex gap-3';
            typingDiv.id = 'typingIndicator';
            typingDiv.innerHTML = `
                <div class="flex-shrink-0 w-7 h-7 rounded-full bg-apple-blue flex items-center justify-center text-white text-xs font-medium">
                    AI
                </div>
                <div class="bg-gray-50 rounded-2xl rounded-tl-sm p-4">
                    <div class="flex gap-1">
                        <span class="w-1.5 h-1.5 bg-gray-400 rounded-full animate-bounce"></span>
                        <span class="w-1.5 h-1.5 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></span>
                        <span class="w-1.5 h-1.5 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></span>
                    </div>
                </div>
            `;
            messagesContainer.appendChild(typingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function hideTyping() {
            const typing = document.getElementById('typingIndicator');
            if (typing) typing.remove();
        }

        function selectOption(option) {
            if (option === 'upload') {
                document.getElementById('uploadZone').classList.remove('hidden');
                addMessage("Please upload your CV and I'll extract all the information.", false);
            } else if (option === 'build') {
                conversationState = 'collecting_info';
                addMessage("Let's build your CV. What's your full name?", false);
            }
        }

        function toggleUpload() {
            const uploadZone = document.getElementById('uploadZone');
            uploadZone.classList.toggle('hidden');
        }

        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            addMessage(`Uploaded: ${file.name}`, true);
            showTyping();

            const formData = new FormData();
            formData.append('file', file);
            formData.append('enhance', 'true');

            try {
                const response = await fetch('/api/v1/cv/extract', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                hideTyping();

                if (response.ok) {
                    cvData = data;
                    updateCVPreview();
                    addMessage("âœ“ CV data extracted successfully! You can now edit or download your CV.", false);
                } else {
                    addMessage(`âœ— Error: ${data.detail}`, false);
                }
            } catch (error) {
                hideTyping();
                addMessage("âœ— Error processing file. Please try again.", false);
            }

            document.getElementById('uploadZone').classList.add('hidden');
            event.target.value = '';
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;

            addMessage(message, true);
            input.value = '';

            showTyping();

            setTimeout(() => {
                hideTyping();
                processUserMessage(message);
            }, 1000);
        }

        function processUserMessage(message) {
            const lowerMessage = message.toLowerCase();

            if (conversationState === 'collecting_info') {
                if (!cvData.contact_info.name) {
                    cvData.contact_info.name = message;
                    updateCVPreview();
                    addMessage(`Nice to meet you, ${message}! What's your email?`, false);
                } else if (!cvData.contact_info.email) {
                    cvData.contact_info.email = message;
                    updateCVPreview();
                    addMessage("Great! What's your phone number?", false);
                } else if (!cvData.contact_info.phone) {
                    cvData.contact_info.phone = message;
                    updateCVPreview();
                    addMessage("Perfect! Tell me about your professional summary.", false);
                } else if (!cvData.summary) {
                    cvData.summary = message;
                    updateCVPreview();
                    addMessage("Excellent! What would you like to add next?", false, [
                        { label: 'Experience', action: "quickAction('experience')" },
                        { label: 'Education', action: "quickAction('education')" },
                        { label: 'Skills', action: "quickAction('skills')" }
                    ]);
                }
            } else {
                addMessage("I understand. Use the quick actions or ask me anything about your CV.", false);
            }
        }

        function quickAction(action) {
            if (action === 'skills') {
                addMessage("Add skills", true);
                addMessage("List your skills separated by commas (e.g., Python, JavaScript, Leadership)", false);
            } else if (action === 'experience') {
                addMessage("Add experience", true);
                addMessage("Tell me about your position:\nâ€¢ Company\nâ€¢ Job title\nâ€¢ Duration\nâ€¢ Responsibilities", false);
            } else if (action === 'education') {
                addMessage("Add education", true);
                addMessage("Provide:\nâ€¢ Degree\nâ€¢ Institution\nâ€¢ Year\nâ€¢ Field of study", false);
            } else if (action === 'clear') {
                if (confirm('Clear chat?')) {
                    location.reload();
                }
            }
        }

        function updateCVPreview() {
            const cvContent = document.getElementById('cvContent');
            
            if (!cvData.contact_info.name && cvData.experiences.length === 0) {
                cvContent.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-center py-16">
                        <div class="w-14 h-14 bg-gray-100 rounded-xl flex items-center justify-center text-2xl mb-3">
                            ðŸ“‹
                        </div>
                        <h3 class="text-base font-semibold text-gray-900 mb-1">Your CV Preview</h3>
                        <p class="text-sm text-gray-500">Start building to see your CV here</p>
                    </div>
                `;
                return;
            }

            let html = '';

            // Contact
            if (cvData.contact_info.name) {
                html += `
                    <div class="mb-6">
                        <h1 class="text-3xl font-bold text-gray-900 mb-2">${cvData.contact_info.name}</h1>
                        <div class="flex flex-wrap gap-3 text-sm text-gray-600">
                            ${cvData.contact_info.email ? `<div>${cvData.contact_info.email}</div>` : ''}
                            ${cvData.contact_info.phone ? `<div>${cvData.contact_info.phone}</div>` : ''}
                            ${cvData.contact_info.location ? `<div>${cvData.contact_info.location}</div>` : ''}
                        </div>
                    </div>
                `;
            }

            // Summary
            if (cvData.summary) {
                html += `
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-2 pb-2 border-b border-gray-200">Summary</h3>
                        <p class="text-sm text-gray-700 leading-relaxed">${cvData.summary}</p>
                    </div>
                `;
            }

            // Experience
            if (cvData.experiences && cvData.experiences.length > 0) {
                html += '<div class="mb-6"><h3 class="text-lg font-semibold text-gray-900 mb-2 pb-2 border-b border-gray-200">Experience</h3>';
                cvData.experiences.forEach(exp => {
                    html += `
                        <div class="mb-4">
                            <h4 class="text-base font-semibold text-gray-900">${exp.job_title || exp.position} at ${exp.company}</h4>
                            <div class="text-xs text-gray-500 mb-1">${exp.start_date || ''} - ${exp.end_date || 'Present'}</div>
                            <p class="text-sm text-gray-700">${exp.description || exp.responsibilities || ''}</p>
                        </div>
                    `;
                });
                html += '</div>';
            }

            // Education
            if (cvData.education && cvData.education.length > 0) {
                html += '<div class="mb-6"><h3 class="text-lg font-semibold text-gray-900 mb-2 pb-2 border-b border-gray-200">Education</h3>';
                cvData.education.forEach(edu => {
                    html += `
                        <div class="mb-3">
                            <h4 class="text-base font-semibold text-gray-900">${edu.degree} in ${edu.field_of_study || 'Field'}</h4>
                            <div class="text-xs text-gray-500">${edu.institution} - ${edu.graduation_date || ''}</div>
                        </div>
                    `;
                });
                html += '</div>';
            }

            // Skills
            if (cvData.skills && cvData.skills.length > 0) {
                html += '<div class="mb-6"><h3 class="text-lg font-semibold text-gray-900 mb-2 pb-2 border-b border-gray-200">Skills</h3><div class="flex flex-wrap gap-2">';
                cvData.skills.forEach(skill => {
                    const skillName = typeof skill === 'string' ? skill : skill.name || skill.skill_name;
                    html += `<span class="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-xs font-medium">${skillName}</span>`;
                });
                html += '</div></div>';
            }

            cvContent.innerHTML = html;
        }

        async function downloadCV(format = 'pdf') {
            if (!cvData.contact_info.name) {
                alert('Please build your CV first!');
                return;
            }

            showTyping();
            addMessage(`Generating ${format.toUpperCase()}...`, false);

            const template = document.getElementById('templateSelect').value;

            try {
                const response = await fetch('/api/v1/cv/fill', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        cv_data: cvData,
                        template_name: template,
                        output_format: format
                    })
                });

                hideTyping();

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `cv_${Date.now()}.${format}`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);

                    addMessage(`âœ“ Downloaded as ${format.toUpperCase()}`, false);
                } else {
                    addMessage("âœ— Error generating CV", false);
                }
            } catch (error) {
                hideTyping();
                addMessage("âœ— Error. Please try again.", false);
            }
        }

        function updateTemplate() {
            const template = document.getElementById('templateSelect').value;
            const names = {
                'modern_cv': 'Modern',
                'classic_cv': 'Classic',
                'executive_cv': 'Executive'
            };
            addMessage(`Template: ${names[template]}`, false);
        }

        // Focus input
        document.getElementById('chatInput').focus();
    </script>

    <script>
        // Sidebar toggle
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            sidebar.classList.toggle('-translate-x-full');
            overlay.classList.toggle('hidden');
        }

        // Logout function
        function logout() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            localStorage.removeItem('user');
            window.location.href = '/auth/signin';
        }
    </script>
</body>
</html>
