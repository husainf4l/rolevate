<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CV Builder - Rolevate CV Builder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
    </style>
    <script>
        // Client-side authentication check and user loading
        (function() {
            const token = localStorage.getItem('access_token');
            if (!token) {
                window.location.href = '/auth/signin?next=/cvbuilder';
                return;
            }

            // Verify token with server
            fetch('/auth/me', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => {
                if (!response.ok) {
                    localStorage.removeItem('access_token');
                    localStorage.removeItem('refresh_token');
                    localStorage.removeItem('user');
                    window.location.href = '/auth/signin?next=/cvbuilder';
                }
                return response.json();
            })
            .then(user => {
                if (user) {
                    // Update all user name elements
                    document.querySelectorAll('.user-name').forEach(el => {
                        el.textContent = user.full_name || user.username || 'User';
                    });

                    // Update user initials
                    document.querySelectorAll('.user-initial').forEach(el => {
                        const name = user.full_name || user.username || 'U';
                        el.textContent = name.charAt(0).toUpperCase();
                    });

                    // Update user email
                    const emailEl = document.getElementById('userEmail');
                    if (emailEl) emailEl.textContent = user.email;

                    localStorage.setItem('user', JSON.stringify(user));
                }
            })
            .catch(error => {
                console.error('Error verifying authentication:', error);
                window.location.href = '/auth/signin?next=/cvbuilder';
            });
        })();

        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'apple-blue': '#007AFF',
                        'apple-gray': '#F5F5F7',
                        'apple-dark': '#1D1D1F',
                    },
                }
            }
        }
    </script>
</head>
<body class="h-full bg-apple-gray flex">

    <!-- Sidebar -->
    <aside id="sidebar" class="fixed inset-y-0 left-0 z-50 w-64 bg-white shadow-lg transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out">
        <div class="flex flex-col h-full">
            <!-- Logo -->
            <div class="flex items-center justify-center h-16 px-4 border-b border-gray-200">
                <a href="/dashboard" class="flex items-center space-x-2">
                    <div class="w-8 h-8 bg-black rounded-lg flex items-center justify-center">
                        <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6z"/>
                            <path d="M14 2v6h6M16 13H8M16 17H8M10 9H8"/>
                        </svg>
                    </div>
                    <span class="text-xl font-semibold text-gray-900">Rolevate</span>
                </a>
            </div>

            <!-- Navigation -->
            <nav class="flex-1 px-4 py-6 space-y-2">
                <a href="/dashboard" class="flex items-center px-4 py-3 text-sm font-medium text-gray-600 hover:text-gray-900 hover:bg-gray-50 rounded-xl transition-colors duration-200">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5a2 2 0 012-2h4a2 2 0 012 2v2H8V5z"/>
                    </svg>
                    Dashboard
                </a>
                <a href="/cvbuilder" class="flex items-center px-4 py-3 text-sm font-medium text-white bg-black rounded-xl transition-colors duration-200">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                    </svg>
                    CV Builder
                </a>
                <a href="/enhance" class="flex items-center px-4 py-3 text-sm font-medium text-gray-600 hover:text-gray-900 hover:bg-gray-50 rounded-xl transition-colors duration-200">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                    </svg>
                    Enhance CV
                </a>
            </nav>

            <!-- User Info -->
            <div class="px-4 py-4 border-t border-gray-200">
                <div class="flex items-center space-x-3 mb-3">
                    <div class="w-10 h-10 rounded-full bg-black flex items-center justify-center text-white text-sm font-semibold">
                        <span class="user-initial">U</span>
                    </div>
                    <div>
                        <div class="text-sm font-semibold text-gray-900 user-name">Loading...</div>
                        <div id="userEmail" class="text-xs text-gray-500">user@example.com</div>
                    </div>
                </div>
                <button onclick="logout()" class="w-full px-4 py-2 text-sm font-medium text-gray-600 hover:text-gray-900 hover:bg-gray-50 rounded-xl transition-colors duration-200">
                    Logout
                </button>
            </div>
        </div>
    </aside>

    <!-- Overlay for mobile -->
    <div id="sidebar-overlay" class="fixed inset-0 z-40 bg-black bg-opacity-50 md:hidden hidden" onclick="toggleSidebar()"></div>

    <!-- Main Content -->
    <div class="flex-1 md:ml-64">
        <!-- Top Bar for Mobile -->
        <div class="md:hidden bg-white border-b border-gray-200 px-4 py-3 flex items-center justify-between">
            <button onclick="toggleSidebar()" class="p-2 text-gray-600 hover:bg-gray-50 rounded-lg">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                </svg>
            </button>
            <span class="text-lg font-semibold text-gray-900">CV Builder</span>
            <div class="w-8"></div>
        </div>

        <div class="h-screen p-6">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 h-full">
            
            <!-- Chat Panel -->
            <div class="flex flex-col bg-white rounded-2xl shadow-sm overflow-hidden">
                <!-- Header -->
                <div class="px-6 py-4 border-b border-gray-100">
                    <div class="flex items-center justify-between">
                        <div>
                            <h1 class="text-xl font-semibold text-gray-900">CV Agent</h1>
                            <p class="text-xs text-gray-500 mt-0.5">AI-powered CV builder</p>
                        </div>
                        <div class="flex items-center gap-1.5 px-2.5 py-1 bg-green-50 rounded-full">
                            <div class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></div>
                            <span class="text-xs font-medium text-green-700">Online</span>
                        </div>
                    </div>
                </div>

                <!-- Messages -->
                <div id="chatMessages" class="flex-1 overflow-y-auto p-6 space-y-4">
                    <!-- Welcome -->
                    <div class="flex gap-3">
                        <div class="flex-shrink-0 w-7 h-7 rounded-full bg-apple-blue flex items-center justify-center text-white text-xs font-medium">
                            AI
                        </div>
                        <div class="flex-1 max-w-lg">
                            <div class="bg-gray-50 rounded-2xl rounded-tl-sm p-4">
                                <p class="text-sm font-medium text-gray-900 mb-2">Welcome to Rolevate</p>
                                <p class="text-sm text-gray-600 mb-3">I can help you create a professional CV:</p>
                                <div class="space-y-1.5 text-xs text-gray-600 mb-4">
                                    <div class="flex items-start gap-2">
                                        <span class="text-apple-blue mt-0.5">•</span>
                                        <span>Extract data from existing CV</span>
                                    </div>
                                    <div class="flex items-start gap-2">
                                        <span class="text-apple-blue mt-0.5">•</span>
                                        <span>Build new CV through conversation</span>
                                    </div>
                                    <div class="flex items-start gap-2">
                                        <span class="text-apple-blue mt-0.5">•</span>
                                        <span>Generate professional templates</span>
                                    </div>
                                </div>
                                <div class="flex flex-wrap gap-2">
                                    <button onclick="selectOption('upload')" class="px-3 py-1.5 bg-apple-blue hover:bg-blue-600 text-white text-xs font-medium rounded-lg transition-colors duration-150">
                                        Upload CV
                                    </button>
                                    <button onclick="selectOption('build')" class="px-3 py-1.5 bg-gray-100 hover:bg-gray-200 text-gray-900 text-xs font-medium rounded-lg transition-colors duration-150">
                                        Build New
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="px-6 py-3 border-t border-gray-100">
                    <div class="flex flex-wrap gap-2">
                        <button onclick="quickAction('skills')" class="px-2.5 py-1 bg-gray-100 hover:bg-gray-200 text-gray-700 text-xs font-medium rounded-full transition-colors duration-150">
                            + Skills
                        </button>
                        <button onclick="quickAction('experience')" class="px-2.5 py-1 bg-gray-100 hover:bg-gray-200 text-gray-700 text-xs font-medium rounded-full transition-colors duration-150">
                            + Experience
                        </button>
                        <button onclick="quickAction('education')" class="px-2.5 py-1 bg-gray-100 hover:bg-gray-200 text-gray-700 text-xs font-medium rounded-full transition-colors duration-150">
                            + Education
                        </button>
                        <button onclick="quickAction('clear')" class="px-2.5 py-1 bg-gray-100 hover:bg-red-50 text-gray-700 hover:text-red-600 text-xs font-medium rounded-full transition-colors duration-150">
                            Clear
                        </button>
                    </div>
                </div>

                <!-- Upload Zone -->
                <div id="uploadZone" class="hidden mx-6 mb-4 border-2 border-dashed border-gray-200 rounded-xl p-6 text-center cursor-pointer hover:border-apple-blue hover:bg-blue-50/50 transition-all duration-200" onclick="document.getElementById('fileInput').click()">
                    <div class="text-2xl mb-2">📄</div>
                    <p class="text-sm font-medium text-gray-700 mb-1">Drop CV or click to browse</p>
                    <p class="text-xs text-gray-500">PDF, DOCX, TXT, JSON (max 10MB)</p>
                    <input type="file" id="fileInput" accept=".pdf,.docx,.txt,.json" onchange="handleFileUpload(event)" class="hidden">
                </div>

                <!-- Input -->
                <div class="px-6 py-4 border-t border-gray-100">
                    <div class="flex gap-2">
                        <button onclick="toggleUpload()" class="flex-shrink-0 w-9 h-9 bg-gray-100 hover:bg-gray-200 rounded-lg flex items-center justify-center text-gray-600 transition-colors duration-150">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path>
                            </svg>
                        </button>
                        <input 
                            type="text" 
                            id="chatInput" 
                            placeholder="Type a message..."
                            class="flex-1 px-4 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-apple-blue focus:border-transparent"
                            onkeypress="handleKeyPress(event)"
                        >
                        <button onclick="sendMessage()" class="flex-shrink-0 px-4 py-2 bg-apple-blue hover:bg-blue-600 text-white text-sm font-medium rounded-lg transition-colors duration-150">
                            Send
                        </button>
                    </div>
                </div>
            </div>

            <!-- Preview Panel -->
            <div class="flex flex-col bg-white rounded-2xl shadow-sm overflow-hidden">
                <!-- Header -->
                <div class="px-6 py-4 border-b border-gray-100">
                    <h2 class="text-lg font-semibold text-gray-900 mb-3">Preview</h2>
                    <div class="flex flex-wrap gap-2">
                        <select id="templateSelect" onchange="updateTemplate()" class="px-3 py-1.5 bg-gray-50 border border-gray-200 text-gray-700 text-xs rounded-lg focus:outline-none focus:ring-2 focus:ring-apple-blue cursor-pointer">
                            <option value="modern_cv">Modern</option>
                            <option value="classic_cv">Classic</option>
                            <option value="executive_cv">Executive</option>
                        </select>
                        <button onclick="downloadCV('pdf')" class="px-3 py-1.5 bg-gray-50 hover:bg-gray-100 border border-gray-200 text-gray-700 text-xs font-medium rounded-lg transition-colors duration-150">
                            PDF
                        </button>
                        <button onclick="downloadCV('docx')" class="px-3 py-1.5 bg-gray-50 hover:bg-gray-100 border border-gray-200 text-gray-700 text-xs font-medium rounded-lg transition-colors duration-150">
                            DOCX
                        </button>
                    </div>
                </div>

                <!-- Content -->
                <div class="flex-1 overflow-y-auto p-6 bg-gray-50">
                    <div id="cvContent" class="bg-white rounded-xl shadow-sm p-8 min-h-full">
                        <!-- Empty State -->
                        <div class="flex flex-col items-center justify-center h-full text-center py-16">
                            <div class="w-14 h-14 bg-gray-100 rounded-xl flex items-center justify-center text-2xl mb-3">
                                📋
                            </div>
                            <h3 class="text-base font-semibold text-gray-900 mb-1">Your CV Preview</h3>
                            <p class="text-sm text-gray-500">Start building to see your CV here</p>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        let cvData = {
            personal_info: {},
            work_experience: [],
            education: [],
            skills: [],
            languages: [],
            certifications: [],
            professional_summary: ''
        };

        let conversationState = 'initial';

        function addMessage(content, isUser = false, options = null) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex gap-3 ${isUser ? 'justify-end' : ''}`;
            
            const avatar = isUser 
                ? '<div class="flex-shrink-0 w-7 h-7 rounded-full bg-gray-200 flex items-center justify-center text-gray-700 text-xs font-medium">You</div>'
                : '<div class="flex-shrink-0 w-7 h-7 rounded-full bg-apple-blue flex items-center justify-center text-white text-xs font-medium">AI</div>';
            
            const bgClass = isUser 
                ? 'bg-apple-blue text-white' 
                : 'bg-gray-50';
            
            const textClass = isUser ? 'text-white' : 'text-gray-700';
            
            const optionsHtml = options 
                ? `<div class="flex flex-wrap gap-2 mt-3">${options.map(opt => 
                    `<button onclick="${opt.action}" class="px-3 py-1.5 bg-apple-blue hover:bg-blue-600 text-white text-xs font-medium rounded-lg transition-colors duration-150">${opt.label}</button>`
                  ).join('')}</div>` 
                : '';
            
            messageDiv.innerHTML = `
                ${!isUser ? avatar : ''}
                <div class="flex-1 ${isUser ? 'max-w-md' : 'max-w-lg'}">
                    <div class="${bgClass} ${isUser ? 'rounded-2xl rounded-tr-sm' : 'rounded-2xl rounded-tl-sm'} p-4">
                        <p class="${textClass} text-sm whitespace-pre-line">${content}</p>
                        ${optionsHtml}
                    </div>
                </div>
                ${isUser ? avatar : ''}
            `;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function showTyping() {
            const messagesContainer = document.getElementById('chatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'flex gap-3';
            typingDiv.id = 'typingIndicator';
            typingDiv.innerHTML = `
                <div class="flex-shrink-0 w-7 h-7 rounded-full bg-apple-blue flex items-center justify-center text-white text-xs font-medium">
                    AI
                </div>
                <div class="bg-gray-50 rounded-2xl rounded-tl-sm p-4">
                    <div class="flex gap-1">
                        <span class="w-1.5 h-1.5 bg-gray-400 rounded-full animate-bounce"></span>
                        <span class="w-1.5 h-1.5 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></span>
                        <span class="w-1.5 h-1.5 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></span>
                    </div>
                </div>
            `;
            messagesContainer.appendChild(typingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function hideTyping() {
            const typing = document.getElementById('typingIndicator');
            if (typing) typing.remove();
        }

        function selectOption(option) {
            if (option === 'upload') {
                document.getElementById('uploadZone').classList.remove('hidden');
                addMessage("Please upload your CV and I'll extract all the information.", false);
            } else if (option === 'build') {
                conversationState = 'collecting_info';
                addMessage("Let's build your CV. What's your full name?", false);
            }
        }

        function toggleUpload() {
            const uploadZone = document.getElementById('uploadZone');
            uploadZone.classList.toggle('hidden');
        }

        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            addMessage(`Uploaded: ${file.name}`, true);
            showTyping();

            const formData = new FormData();
            formData.append('file', file);
            formData.append('enhance', 'true');

            try {
                const response = await fetch('/api/v1/cv/extract', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                hideTyping();

                if (response.ok) {
                    cvData = data;
                    updateCVPreview();
                    addMessage("✓ CV data extracted successfully! You can now edit or download your CV.", false);
                } else {
                    addMessage(`✗ Error: ${data.detail}`, false);
                }
            } catch (error) {
                hideTyping();
                addMessage("✗ Error processing file. Please try again.", false);
            }

            document.getElementById('uploadZone').classList.add('hidden');
            event.target.value = '';
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;

            addMessage(message, true);
            input.value = '';

            showTyping();

            // Call LLM-powered backend API instead of static responses
            await processUserMessage(message);
        }

        async function processUserMessage(message) {
            try {
                // Get auth token
                const token = localStorage.getItem('access_token');
                
                // Call the LLM-powered backend API (correct endpoint: /api/v1/chat)
                const response = await fetch('/api/v1/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        message: message,
                        session_id: getSessionId(),
                        user_id: null
                    })
                });

                hideTyping();

                if (!response.ok) {
                    throw new Error(`API request failed with status ${response.status}`);
                }

                const data = await response.json();
                
                // API returns: { response, session_id, cv_progress, suggestions, download_url }
                // Update CV data from cv_progress
                if (data.cv_progress && data.cv_progress.cv_memory) {
                    cvData = data.cv_progress.cv_memory;
                    updateCVPreview();
                }

                // Display AI response (powered by GPT-4)
                addMessage(data.response || data.ai_response, false);

                // Log extraction details for debugging
                console.log('🤖 Session:', data.session_id);
                console.log('📊 CV Progress:', data.cv_progress);
                console.log('� Suggestions:', data.suggestions);

            } catch (error) {
                hideTyping();
                console.error('Error calling LLM backend:', error);
                addMessage("I'm having trouble connecting right now. Please try again in a moment.", false);
            }
        }

        // Generate or retrieve session ID
        function getSessionId() {
            let sessionId = sessionStorage.getItem('cv_session_id');
            if (!sessionId) {
                sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                sessionStorage.setItem('cv_session_id', sessionId);
            }
            return sessionId;
        }

        async function quickAction(action) {
            if (action === 'skills') {
                addMessage("Add skills", true);
                showTyping();
                await processUserMessage("I want to add my skills");
            } else if (action === 'experience') {
                addMessage("Add experience", true);
                showTyping();
                await processUserMessage("I want to add my work experience");
            } else if (action === 'education') {
                addMessage("Add education", true);
                showTyping();
                await processUserMessage("I want to add my education");
            } else if (action === 'clear') {
                if (confirm('Clear chat and CV data?')) {
                    location.reload();
                }
            }
        }

        function updateCVPreview() {
            const cvContent = document.getElementById('cvContent');
            
            // Check if CV has any data
            const hasPersonalInfo = cvData.personal_info && Object.keys(cvData.personal_info).length > 0;
            const hasExperience = cvData.work_experience && cvData.work_experience.length > 0;
            const hasEducation = cvData.education && cvData.education.length > 0;
            const hasSummary = cvData.professional_summary && cvData.professional_summary.length > 0;
            
            if (!hasPersonalInfo && !hasExperience && !hasEducation && !hasSummary) {
                cvContent.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-center py-16">
                        <div class="w-14 h-14 bg-gray-100 rounded-xl flex items-center justify-center text-2xl mb-3">
                            📋
                        </div>
                        <h3 class="text-base font-semibold text-gray-900 mb-1">Your CV Preview</h3>
                        <p class="text-sm text-gray-500">Start chatting to build your CV</p>
                    </div>
                `;
                return;
            }

            let html = '';

            // Personal Info / Contact - Enhanced Header
            if (hasPersonalInfo) {
                const info = cvData.personal_info;
                const name = info.name || info.full_name || 'Your Name';
                const hasContact = info.email || info.phone || info.location || info.address || info.linkedin || info.github || info.website;
                
                html += `
                    <div class="mb-8 pb-6 border-b-2 border-gray-200">
                        <h1 class="text-4xl font-bold text-gray-900 mb-3 tracking-tight">${name}</h1>
                        ${hasContact ? `
                            <div class="flex flex-wrap gap-4 text-sm text-gray-600">
                                ${info.email ? `<div class="flex items-center gap-1.5"><span class="text-blue-600">📧</span><a href="mailto:${info.email}" class="hover:text-blue-600 hover:underline">${info.email}</a></div>` : ''}
                                ${info.phone ? `<div class="flex items-center gap-1.5"><span class="text-green-600">📱</span><a href="tel:${info.phone}" class="hover:text-green-600 hover:underline">${info.phone}</a></div>` : ''}
                                ${info.location || info.address ? `<div class="flex items-center gap-1.5"><span class="text-red-600">📍</span><span>${info.location || info.address}</span></div>` : ''}
                                ${info.linkedin ? `<div class="flex items-center gap-1.5"><span class="text-blue-700">💼</span><a href="${info.linkedin.startsWith('http') ? info.linkedin : 'https://linkedin.com/in/' + info.linkedin}" target="_blank" class="hover:text-blue-700 hover:underline">LinkedIn</a></div>` : ''}
                                ${info.github ? `<div class="flex items-center gap-1.5"><span class="text-gray-800">🔗</span><a href="${info.github.startsWith('http') ? info.github : 'https://github.com/' + info.github}" target="_blank" class="hover:text-gray-800 hover:underline">GitHub</a></div>` : ''}
                                ${info.website ? `<div class="flex items-center gap-1.5"><span class="text-purple-600">🌐</span><a href="${info.website.startsWith('http') ? info.website : 'https://' + info.website}" target="_blank" class="hover:text-purple-600 hover:underline">Website</a></div>` : ''}
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            // Professional Summary - Enhanced
            if (hasSummary) {
                html += `
                    <div class="mb-7">
                        <h2 class="text-xl font-bold text-gray-900 mb-3 flex items-center gap-2">
                            <span class="w-1 h-6 bg-blue-600 rounded"></span>
                            <span>Professional Summary</span>
                        </h2>
                        <p class="text-sm text-gray-700 leading-relaxed pl-3 border-l-2 border-gray-200">${cvData.professional_summary}</p>
                    </div>
                `;
            }

            // Work Experience - Enhanced with better layout
            if (hasExperience) {
                html += `
                    <div class="mb-7">
                        <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
                            <span class="w-1 h-6 bg-blue-600 rounded"></span>
                            <span>Work Experience</span>
                        </h2>
                `;
                cvData.work_experience.forEach((exp, index) => {
                    // Handle both start_date/end_date and start_year/end_year formats
                    const startDate = exp.start_date || exp.start_year || '';
                    const endDate = exp.end_date || exp.end_year || 'Present';
                    const position = exp.job_title || exp.position || 'Position';
                    const company = exp.company || exp.organization || 'Company';
                    const dateRange = startDate && endDate ? `${startDate} - ${endDate}` : '';
                    
                    html += `
                        <div class="mb-5 pl-3 border-l-2 ${index === cvData.work_experience.length - 1 ? 'border-gray-200' : 'border-blue-100'}">
                            <div class="flex justify-between items-start mb-1">
                                <h3 class="text-base font-bold text-gray-900">${position}</h3>
                                ${dateRange ? `<span class="text-xs text-gray-500 font-medium px-2 py-1 bg-gray-100 rounded">${dateRange}</span>` : ''}
                            </div>
                            <div class="text-sm font-semibold text-blue-600 mb-2">${company}</div>
                            ${exp.description ? `<p class="text-sm text-gray-700 mb-2 leading-relaxed">${exp.description}</p>` : ''}
                            ${exp.key_responsibilities && exp.key_responsibilities.length > 0 ? `
                                <ul class="text-sm text-gray-700 space-y-1.5">
                                    ${exp.key_responsibilities.map(r => `<li class="flex items-start gap-2"><span class="text-blue-600 mt-0.5">•</span><span>${r}</span></li>`).join('')}
                                </ul>
                            ` : ''}
                            ${exp.achievements && exp.achievements.length > 0 ? `
                                <ul class="mt-2 text-sm text-gray-700 space-y-1.5">
                                    ${exp.achievements.map(a => `<li class="flex items-start gap-2"><span class="text-green-600 mt-0.5">✓</span><span>${a}</span></li>`).join('')}
                                </ul>
                            ` : ''}
                        </div>
                    `;
                });
                html += '</div>';
            }

            // Education - Enhanced
            if (hasEducation) {
                html += `
                    <div class="mb-7">
                        <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
                            <span class="w-1 h-6 bg-blue-600 rounded"></span>
                            <span>Education</span>
                        </h2>
                `;
                cvData.education.forEach(edu => {
                    const degree = edu.degree || 'Degree';
                    const institution = edu.institution || 'Institution';
                    const field = edu.field_of_study ? ` in ${edu.field_of_study}` : '';
                    const year = edu.graduation_year || edu.end_date || edu.year || '';
                    
                    html += `
                        <div class="mb-4 pl-3 border-l-2 border-gray-200">
                            <div class="flex justify-between items-start mb-1">
                                <h3 class="text-base font-bold text-gray-900">${degree}${field}</h3>
                                ${year ? `<span class="text-xs text-gray-500 font-medium px-2 py-1 bg-gray-100 rounded">${year}</span>` : ''}
                            </div>
                            <div class="text-sm font-semibold text-blue-600">${institution}</div>
                            ${edu.gpa ? `<div class="text-xs text-gray-600 mt-1.5 flex items-center gap-1"><span class="font-semibold">GPA:</span><span>${edu.gpa}</span></div>` : ''}
                        </div>
                    `;
                });
                html += '</div>';
            }

            // Skills - Enhanced
            if (cvData.skills && cvData.skills.length > 0) {
                html += `
                    <div class="mb-7">
                        <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
                            <span class="w-1 h-6 bg-blue-600 rounded"></span>
                            <span>Skills</span>
                        </h2>
                        <div class="flex flex-wrap gap-2">
                `;
                cvData.skills.forEach(skill => {
                    const skillName = typeof skill === 'string' ? skill : skill.name || skill.skill_name || skill;
                    html += `<span class="px-3 py-1.5 bg-blue-50 text-blue-700 rounded-full text-sm font-medium border border-blue-200 hover:bg-blue-100 transition-colors">${skillName}</span>`;
                });
                html += '</div></div>';
            }

            // Projects - Enhanced
            if (cvData.projects && cvData.projects.length > 0) {
                html += `
                    <div class="mb-7">
                        <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
                            <span class="w-1 h-6 bg-blue-600 rounded"></span>
                            <span>Projects</span>
                        </h2>
                `;
                cvData.projects.forEach(project => {
                    const projectName = typeof project === 'string' ? project : project.project_name || project.name || 'Project';
                    const description = typeof project === 'object' ? project.description || '' : '';
                    const role = typeof project === 'object' ? project.role || '' : '';
                    const technologies = typeof project === 'object' && project.technologies ? project.technologies : [];
                    html += `
                        <div class="mb-5 pl-3 border-l-2 border-purple-100">
                            <div class="flex justify-between items-start mb-1.5">
                                <h3 class="text-base font-bold text-gray-900">${projectName}</h3>
                                ${role ? `<span class="text-xs font-medium px-2 py-1 bg-purple-50 text-purple-700 rounded border border-purple-200">${role}</span>` : ''}
                            </div>
                            ${description ? `<p class="text-sm text-gray-700 mb-2 leading-relaxed">${description}</p>` : ''}
                            ${technologies.length > 0 ? `
                                <div class="flex flex-wrap gap-1.5 mt-2">
                                    ${technologies.map(tech => `<span class="text-xs px-2 py-1 bg-gray-50 text-gray-700 rounded border border-gray-200">${tech}</span>`).join('')}
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
                html += '</div>';
            }

            // Languages - Enhanced
            if (cvData.languages && cvData.languages.length > 0) {
                html += `
                    <div class="mb-7">
                        <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
                            <span class="w-1 h-6 bg-blue-600 rounded"></span>
                            <span>Languages</span>
                        </h2>
                        <div class="grid grid-cols-2 gap-3">
                `;
                cvData.languages.forEach(lang => {
                    const langName = typeof lang === 'string' ? lang : lang.language || lang.name;
                    const proficiency = typeof lang === 'object' ? lang.proficiency || '' : '';
                    html += `
                        <div class="flex items-center justify-between p-2 bg-gray-50 rounded border border-gray-200">
                            <span class="text-sm font-semibold text-gray-900">${langName}</span>
                            ${proficiency ? `<span class="text-xs px-2 py-0.5 bg-green-100 text-green-700 rounded font-medium">${proficiency}</span>` : ''}
                        </div>
                    `;
                });
                html += '</div></div>';
            }

            // Certifications
            if (cvData.certifications && cvData.certifications.length > 0) {
                html += '<div class="mb-6"><h3 class="text-lg font-semibold text-gray-900 mb-2 pb-2 border-b border-gray-200">Certifications</h3>';
                cvData.certifications.forEach(cert => {
                    const certName = typeof cert === 'string' ? cert : cert.name || cert.certification;
                    const issuer = typeof cert === 'object' ? cert.issuer || cert.organization : '';
                    const date = typeof cert === 'object' ? cert.date || cert.year : '';
                    html += `
                        <div class="mb-2">
                            <div class="text-sm font-medium text-gray-900">${certName}</div>
                            ${issuer ? `<div class="text-xs text-gray-600">${issuer}</div>` : ''}
                            ${date ? `<div class="text-xs text-gray-500">${date}</div>` : ''}
                        </div>
                    `;
                });
                html += '</div>';
            }

            cvContent.innerHTML = html;
        }

        async function downloadCV(format = 'pdf') {
            // Check if CV has any data
            const hasData = (cvData.personal_info && Object.keys(cvData.personal_info).length > 0) ||
                           (cvData.work_experience && cvData.work_experience.length > 0) ||
                           (cvData.education && cvData.education.length > 0);
            
            if (!hasData) {
                alert('Please build your CV first by chatting with the AI!');
                return;
            }

            showTyping();
            addMessage(`Generating ${format.toUpperCase()}...`, false);

            const template = document.getElementById('templateSelect').value;

            try {
                const response = await fetch('/api/v1/cv/fill', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        cv_data: cvData,
                        template_name: template,
                        output_format: format
                    })
                });

                hideTyping();

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `cv_${Date.now()}.${format}`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);

                    addMessage(`✓ Downloaded as ${format.toUpperCase()}`, false);
                } else {
                    addMessage("✗ Error generating CV", false);
                }
            } catch (error) {
                hideTyping();
                addMessage("✗ Error. Please try again.", false);
            }
        }

        function updateTemplate() {
            const template = document.getElementById('templateSelect').value;
            const names = {
                'modern_cv': 'Modern',
                'classic_cv': 'Classic',
                'executive_cv': 'Executive'
            };
            addMessage(`Template: ${names[template]}`, false);
        }

        // Focus input and initialize chat with LLM greeting
        document.getElementById('chatInput').focus();
        
        // Initialize chat with AI greeting
        (async function initializeChat() {
            showTyping();
            try {
                const token = localStorage.getItem('access_token');
                const response = await fetch('/api/v1/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        message: "Hello, I want to build my CV",
                        session_id: getSessionId(),
                        user_id: null
                    })
                });
                
                hideTyping();
                
                if (response.ok) {
                    const data = await response.json();
                    addMessage(data.response || data.ai_response, false);
                } else {
                    // Fallback greeting
                    addMessage("👋 Welcome to Rolevate CV Builder! I'm your AI assistant powered by GPT-4. Tell me about your professional experience, and I'll help you create an outstanding CV. You can describe your background in natural language, and I'll intelligently extract and structure the information.", false);
                }
            } catch (error) {
                hideTyping();
                // Fallback greeting
                addMessage("👋 Welcome to Rolevate CV Builder! I'm your AI assistant. Tell me about your professional experience, and I'll help you create an outstanding CV.", false);
            }
        })();
    </script>

    <script>
        // Sidebar toggle
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            sidebar.classList.toggle('-translate-x-full');
            overlay.classList.toggle('hidden');
        }

        // Logout function
        function logout() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            localStorage.removeItem('user');
            window.location.href = '/auth/signin';
        }
    </script>
</body>
</html>
