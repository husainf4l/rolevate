<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LiveKit Interview Room</title>
    <script src="https://cdn.jsdelivr.net/npm/livekit-client@2.5.8/dist/livekit-client.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 1200px;
            width: 100%;
            padding: 30px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 14px;
        }

        .connection-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 600;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        button {
            flex: 1;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-connect {
            background: #667eea;
            color: white;
        }

        .btn-connect:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-disconnect {
            background: #dc3545;
            color: white;
            display: none;
        }

        .btn-disconnect:hover {
            background: #c82333;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(220, 53, 69, 0.4);
        }

        .btn-disconnect.active {
            display: block;
        }

        .status {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 600;
            text-align: center;
        }

        .status.disconnected {
            background: #fff3cd;
            color: #856404;
            border: 2px solid #ffc107;
        }

        .status.connecting {
            background: #d1ecf1;
            color: #0c5460;
            border: 2px solid #17a2b8;
        }

        .status.connected {
            background: #d4edda;
            color: #155724;
            border: 2px solid #28a745;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #dc3545;
        }

        .video-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .participant {
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            aspect-ratio: 16/9;
        }

        .participant video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .participant audio {
            display: none;
        }

        .participant-info {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 14px;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .control-btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .control-btn.mute-audio {
            background: #28a745;
            color: white;
        }

        .control-btn.mute-audio.muted {
            background: #dc3545;
        }

        .control-btn.mute-video {
            background: #007bff;
            color: white;
        }

        .control-btn.mute-video.muted {
            background: #dc3545;
        }

        .hidden {
            display: none;
        }

        .logs {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .log-entry {
            padding: 5px;
            margin-bottom: 5px;
            border-left: 3px solid #667eea;
            padding-left: 10px;
        }

        .log-entry.error {
            border-left-color: #dc3545;
            color: #dc3545;
        }

        .log-entry.success {
            border-left-color: #28a745;
            color: #28a745;
        }

        .transcript {
            background: #fff;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
        }

        .transcript h3 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 18px;
        }

        .transcript-entry {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 5px;
        }

        .transcript-entry.agent {
            background: #e3f2fd;
            border-left: 3px solid #2196f3;
        }

        .transcript-entry.user {
            background: #f3e5f5;
            border-left: 3px solid #9c27b0;
        }

        .transcript-entry .speaker {
            font-weight: 600;
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .transcript-entry .text {
            color: #333;
            line-height: 1.5;
        }

        .transcript-entry .timestamp {
            font-size: 11px;
            color: #999;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé• LiveKit Interview Room</h1>
            <p>Connect to your interview session</p>
        </div>

        <div id="status" class="status disconnected">
            Disconnected
        </div>

        <div class="connection-form">
            <div class="form-group">
                <label for="url">LiveKit Server URL</label>
                <input type="text" id="url" value="wss://rolvate2-ckmk80qb.livekit.cloud" placeholder="wss://your-server.livekit.cloud">
            </div>

            <div class="form-group">
                <label for="token">Access Token</label>
                <input type="text" id="token" value="" placeholder="Paste your token here">
            </div>

            <div class="form-group">
                <label for="roomName">Room Name</label>
                <input type="text" id="roomName" value="6f5b51c8-dbae-4557-9a2d-40afa92eecae" placeholder="Paste your room name here">
            </div>

            <div class="button-group">
                <button id="connectBtn" class="btn-connect">Connect to Room</button>
                <button id="disconnectBtn" class="btn-disconnect">Disconnect</button>
            </div>
        </div>

        <div id="controls" class="controls hidden">
            <button id="muteAudioBtn" class="control-btn mute-audio">Mute Audio</button>
            <button id="muteVideoBtn" class="control-btn mute-video">Disable Video</button>
        </div>

        <div id="videoContainer" class="video-container"></div>

        <div class="transcript">
            <h3>üìù Live Transcript</h3>
            <div id="transcriptContainer"></div>
        </div>

        <div class="logs">
            <h3>Connection Logs</h3>
            <div id="logContainer"></div>
        </div>
    </div>

    <script>
        let room;
        let localAudioTrack;
        let localVideoTrack;
        let isAudioMuted = false;
        let isVideoMuted = false;

        const statusEl = document.getElementById('status');
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const videoContainer = document.getElementById('videoContainer');
        const controlsEl = document.getElementById('controls');
        const muteAudioBtn = document.getElementById('muteAudioBtn');
        const muteVideoBtn = document.getElementById('muteVideoBtn');
        const logContainer = document.getElementById('logContainer');
        const transcriptContainer = document.getElementById('transcriptContainer');

        function addLog(message, type = 'info') {
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function addTranscript(speaker, text, isFinal = true) {
            const entry = document.createElement('div');
            entry.className = `transcript-entry ${speaker}`;
            entry.innerHTML = `
                <div class="speaker">${speaker === 'agent' ? 'ü§ñ AI Interviewer' : 'üë§ You'}</div>
                <div class="text">${text}</div>
                <div class="timestamp">${new Date().toLocaleTimeString()}</div>
            `;
            transcriptContainer.appendChild(entry);
            transcriptContainer.scrollTop = transcriptContainer.scrollHeight;
        }

        function updateStatus(status, message) {
            statusEl.className = `status ${status}`;
            statusEl.textContent = message;
        }

        async function requestAgentDispatch(roomName) {
            try {
                addLog('ü§ñ Requesting agent to join room...', 'info');
                
                const apiKey = 'APIYBd8YH53faWX';
                const apiSecret = 'fgQLGjbNx1WJ42Y4LOlySajbjJoR1CYwXmslUu1ftLfB';
                const livekitHost = 'rolvate2-ckmk80qb.livekit.cloud';
                
                // Since the agent worker doesn't have an agent_name set, 
                // it uses automatic dispatch which only works for NEW rooms.
                // The room already exists, so we need to create a NEW room for the agent to join
                
                addLog('‚ÑπÔ∏è Note: Agent automatically joins NEW rooms only', 'info');
                addLog('‚ÑπÔ∏è Disconnect and create a fresh room, OR', 'info');
                addLog('‚ÑπÔ∏è Restart agent and connect to a new room name', 'info');
                
            } catch (error) {
                console.error('Agent dispatch error:', error);
                addLog(`‚ö†Ô∏è Could not request agent: ${error.message}`, 'error');
            }
        }

        async function connectToRoom() {
            try {
                const url = document.getElementById('url').value;
                const roomName = document.getElementById('roomName').value;

                if (!url || !roomName) {
                    alert('Please enter both URL and room name');
                    return;
                }

                // Request room and token from backend
                try {
                    addLog('Requesting room and token from backend...', 'info');
                    const query = `mutation CreateInterviewRoom($applicationId: String!) {
                        createInterviewRoom(createRoomInput: { applicationId: $applicationId }) {
                            roomName
                            message
                            token
                        }
                    }`;
                    const variables = { applicationId: roomName };
                    const response = await fetch('http://localhost:4005/api/graphql', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ query, variables })
                    });
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    const data = await response.json();
                    if (data.errors) {
                        throw new Error(data.errors[0].message);
                    }
                    const { roomName: newRoomName, token: newToken } = data.data.createInterviewRoom;
                    document.getElementById('roomName').value = newRoomName;
                    document.getElementById('token').value = newToken;
                    addLog('‚úÖ Room and token received from backend', 'success');
                } catch (error) {
                    console.error('Backend request error:', error);
                    addLog(`‚ùå Failed to get room/token: ${error.message}`, 'error');
                    return;
                }

                const token = document.getElementById('token').value;

                if (!token) {
                    alert('Failed to obtain token');
                    return;
                }

                updateStatus('connecting', 'Connecting...');
                addLog('Attempting to connect to LiveKit room...', 'info');

                // Create room instance
                room = new LivekitClient.Room({
                    adaptiveStream: true,
                    dynacast: true,
                    videoCaptureDefaults: {
                        resolution: LivekitClient.VideoPresets.h720.resolution,
                    },
                });

                // Set up room event listeners
                room.on(LivekitClient.RoomEvent.TrackSubscribed, handleTrackSubscribed);
                room.on(LivekitClient.RoomEvent.TrackUnsubscribed, handleTrackUnsubscribed);
                room.on(LivekitClient.RoomEvent.ActiveSpeakersChanged, handleActiveSpeakerChange);
                room.on(LivekitClient.RoomEvent.Disconnected, handleDisconnect);
                room.on(LivekitClient.RoomEvent.LocalTrackPublished, handleLocalTrackPublished);
                room.on(LivekitClient.RoomEvent.ParticipantConnected, handleParticipantConnected);
                room.on(LivekitClient.RoomEvent.ParticipantDisconnected, handleParticipantDisconnected);
                room.on(LivekitClient.RoomEvent.TrackTranscriptionReceived, handleTranscription);

                // Connect to the room
                await room.connect(url, token);

                addLog('‚úÖ Connected successfully!', 'success');
                updateStatus('connected', `Connected to room: ${room.name}`);

                // Enable local audio and video
                await enableLocalMedia();

                // Show controls
                controlsEl.classList.remove('hidden');
                connectBtn.style.display = 'none';
                disconnectBtn.classList.add('active');

            } catch (error) {
                console.error('Connection error:', error);
                addLog(`‚ùå Connection failed: ${error.message}`, 'error');
                updateStatus('error', `Connection failed: ${error.message}`);
            }
        }

        async function enableLocalMedia() {
            try {
                addLog('Enabling microphone...', 'info');

                // Enable microphone
                try {
                    localAudioTrack = await LivekitClient.createLocalAudioTrack();
                    await room.localParticipant.publishTrack(localAudioTrack);
                    addLog('‚úÖ Microphone enabled', 'success');
                } catch (error) {
                    console.error('Microphone error:', error);
                    addLog(`‚ö†Ô∏è Microphone access error: ${error.message}`, 'error');
                }

                // Try to enable camera (optional)
                try {
                    addLog('Attempting to enable camera...', 'info');
                    localVideoTrack = await LivekitClient.createLocalVideoTrack();
                    await room.localParticipant.publishTrack(localVideoTrack);
                    addLog('‚úÖ Camera enabled', 'success');

                    // Attach local video
                    const videoElement = localVideoTrack.attach();
                    videoElement.style.transform = 'scaleX(-1)'; // Mirror local video
                    
                    const participantDiv = createParticipantElement(room.localParticipant, videoElement);
                    videoContainer.appendChild(participantDiv);
                } catch (error) {
                    console.error('Camera error:', error);
                    addLog(`‚ÑπÔ∏è Camera not available (audio-only mode) - ${error.message}`, 'info');
                    
                    // Create audio-only placeholder for local participant
                    const participantDiv = document.createElement('div');
                    participantDiv.className = 'participant';
                    participantDiv.id = `participant-${room.localParticipant.identity}`;
                    participantDiv.style.display = 'flex';
                    participantDiv.style.alignItems = 'center';
                    participantDiv.style.justifyContent = 'center';
                    participantDiv.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                    
                    const placeholder = document.createElement('div');
                    placeholder.style.textAlign = 'center';
                    placeholder.style.color = 'white';
                    placeholder.innerHTML = `
                        <div style="font-size: 48px; margin-bottom: 10px;">üé§</div>
                        <div style="font-size: 18px; font-weight: 600;">${room.localParticipant.identity}</div>
                        <div style="font-size: 14px; opacity: 0.8; margin-top: 5px;">Audio Only</div>
                    `;
                    participantDiv.appendChild(placeholder);
                    
                    const info = document.createElement('div');
                    info.className = 'participant-info';
                    info.textContent = room.localParticipant.identity + ' (You - Audio Only)';
                    participantDiv.appendChild(info);
                    
                    videoContainer.appendChild(participantDiv);
                }

            } catch (error) {
                console.error('Media error:', error);
                addLog(`‚ùå Media setup error: ${error.message}`, 'error');
            }
        }

        function createParticipantElement(participant, videoElement) {
            const div = document.createElement('div');
            div.className = 'participant';
            div.id = `participant-${participant.identity}`;
            
            div.appendChild(videoElement);
            
            const info = document.createElement('div');
            info.className = 'participant-info';
            info.textContent = participant.identity + (participant.isLocal ? ' (You)' : '');
            div.appendChild(info);
            
            return div;
        }

        function handleTrackSubscribed(track, publication, participant) {
            addLog(`üìπ Track subscribed from ${participant.identity}`, 'info');

            if (track.kind === 'video' || track.kind === 'audio') {
                const element = track.attach();
                
                if (track.kind === 'video') {
                    const participantDiv = createParticipantElement(participant, element);
                    videoContainer.appendChild(participantDiv);
                } else {
                    // Audio track - just append to body (invisible)
                    document.body.appendChild(element);
                }
            }
        }

        function handleTrackUnsubscribed(track, publication, participant) {
            addLog(`Track unsubscribed from ${participant.identity}`, 'info');
            track.detach().forEach(element => element.remove());
            
            if (track.kind === 'video') {
                const participantDiv = document.getElementById(`participant-${participant.identity}`);
                if (participantDiv) {
                    participantDiv.remove();
                }
            }
        }

        function handleActiveSpeakerChange(speakers) {
            // Highlight active speakers
            const allParticipants = document.querySelectorAll('.participant');
            allParticipants.forEach(p => p.style.border = 'none');
            
            speakers.forEach(speaker => {
                const participantDiv = document.getElementById(`participant-${speaker.identity}`);
                if (participantDiv) {
                    participantDiv.style.border = '3px solid #28a745';
                }
            });
        }

        function handleParticipantConnected(participant) {
            addLog(`üë§ Participant connected: ${participant.identity}`, 'success');
        }

        function handleParticipantDisconnected(participant) {
            addLog(`üë§ Participant disconnected: ${participant.identity}`, 'info');
        }

        function handleLocalTrackPublished(publication, participant) {
            addLog(`üì§ Published ${publication.kind} track`, 'success');
        }

        function handleTranscription(transcription, publication, participant) {
            // Only process final transcriptions to avoid duplicates
            if (transcription.final) {
                const speaker = participant.isLocal ? 'user' : 'agent';
                addTranscript(speaker, transcription.text, true);
                addLog(`üìù Transcription: ${transcription.text.substring(0, 50)}...`, 'info');
            }
        }

        function handleDisconnect() {
            addLog('Disconnected from room', 'info');
            updateStatus('disconnected', 'Disconnected');
            cleanup();
        }

        async function disconnectFromRoom() {
            if (room) {
                await room.disconnect();
                cleanup();
            }
        }

        function cleanup() {
            videoContainer.innerHTML = '';
            transcriptContainer.innerHTML = '';
            controlsEl.classList.add('hidden');
            connectBtn.style.display = 'block';
            disconnectBtn.classList.remove('active');
            room = null;
            localAudioTrack = null;
            localVideoTrack = null;
            isAudioMuted = false;
            isVideoMuted = false;
            muteAudioBtn.textContent = 'Mute Audio';
            muteAudioBtn.classList.remove('muted');
            muteVideoBtn.textContent = 'Disable Video';
            muteVideoBtn.classList.remove('muted');
        }

        async function toggleAudio() {
            if (!localAudioTrack) return;

            if (isAudioMuted) {
                await localAudioTrack.unmute();
                muteAudioBtn.textContent = 'Mute Audio';
                muteAudioBtn.classList.remove('muted');
                addLog('üîä Audio unmuted', 'info');
            } else {
                await localAudioTrack.mute();
                muteAudioBtn.textContent = 'Unmute Audio';
                muteAudioBtn.classList.add('muted');
                addLog('üîá Audio muted', 'info');
            }
            isAudioMuted = !isAudioMuted;
        }

        async function toggleVideo() {
            if (!localVideoTrack) {
                addLog('‚ÑπÔ∏è No camera available', 'info');
                return;
            }

            if (isVideoMuted) {
                await localVideoTrack.unmute();
                muteVideoBtn.textContent = 'Disable Video';
                muteVideoBtn.classList.remove('muted');
                addLog('üìπ Video enabled', 'info');
            } else {
                await localVideoTrack.mute();
                muteVideoBtn.textContent = 'Enable Video';
                muteVideoBtn.classList.add('muted');
                addLog('üìπ Video disabled', 'info');
            }
            isVideoMuted = !isVideoMuted;
        }

        // Event listeners
        connectBtn.addEventListener('click', connectToRoom);
        disconnectBtn.addEventListener('click', disconnectFromRoom);
        muteAudioBtn.addEventListener('click', toggleAudio);
        muteVideoBtn.addEventListener('click', toggleVideo);

        // Initial log
        addLog('Ready to connect', 'info');
    </script>
</body>
</html>
