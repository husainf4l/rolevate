<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rolevate Agent Controller</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        [v-cloak] { display: none; }
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-running { background-color: #10b981; animation: pulse 2s infinite; }
        .status-stopped { background-color: #ef4444; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .log-viewer {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
            max-height: 400px;
            overflow-y: auto;
            background-color: #1e1e1e;
            color: #d4d4d4;
            padding: 16px;
            border-radius: 8px;
        }
        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app" v-cloak>
        <!-- Header -->
        <header class="bg-white shadow-sm">
            <div class="container mx-auto px-6 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <i class="fas fa-robot text-4xl text-indigo-600"></i>
                        <div>
                            <h1 class="text-2xl font-bold text-gray-800">Rolevate Agent Controller</h1>
                            <p class="text-sm text-gray-500">Real-time monitoring and control</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center">
                            <span :class="['status-dot', status.is_running ? 'status-running' : 'status-stopped']"></span>
                            <span class="font-semibold" :class="status.is_running ? 'text-green-600' : 'text-red-600'">
                                {{ status.is_running ? 'Running' : 'Stopped' }}
                            </span>
                        </div>
                        <span class="text-sm text-gray-400">{{ currentTime }}</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="container mx-auto px-6 py-8">
            <!-- Control Panel -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-sliders-h mr-2 text-indigo-600"></i>
                    Agent Control
                </h2>
                <div class="flex space-x-4">
                    <button @click="startAgent" 
                            :disabled="status.is_running || loading"
                            class="flex-1 bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-6 rounded-lg transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center">
                        <i class="fas fa-play mr-2"></i>
                        Start Agent
                    </button>
                    <button @click="stopAgent"
                            :disabled="!status.is_running || loading"
                            class="flex-1 bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-6 rounded-lg transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center">
                        <i class="fas fa-stop mr-2"></i>
                        Stop Agent
                    </button>
                    <button @click="restartAgent"
                            :disabled="loading"
                            class="flex-1 bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-3 px-6 rounded-lg transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center">
                        <i class="fas fa-redo mr-2"></i>
                        Restart Agent
                    </button>
                    <button @click="refreshStatus"
                            :disabled="loading"
                            class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fas fa-sync-alt" :class="{ 'fa-spin': loading }"></i>
                    </button>
                </div>
            </div>

            <!-- Metrics Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <!-- Uptime -->
                <div class="card bg-white rounded-lg shadow-md p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-500 mb-1">Uptime</p>
                            <p class="text-2xl font-bold text-gray-800">{{ formatUptime(status.uptime) }}</p>
                        </div>
                        <div class="bg-blue-100 p-3 rounded-full">
                            <i class="fas fa-clock text-2xl text-blue-600"></i>
                        </div>
                    </div>
                </div>

                <!-- Memory Usage -->
                <div class="card bg-white rounded-lg shadow-md p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-500 mb-1">Memory</p>
                            <p class="text-2xl font-bold text-gray-800">{{ formatMemory(status.memory_usage) }}</p>
                        </div>
                        <div class="bg-purple-100 p-3 rounded-full">
                            <i class="fas fa-memory text-2xl text-purple-600"></i>
                        </div>
                    </div>
                </div>

                <!-- CPU Usage -->
                <div class="card bg-white rounded-lg shadow-md p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-500 mb-1">CPU</p>
                            <p class="text-2xl font-bold text-gray-800">{{ formatCpu(status.cpu_usage) }}</p>
                        </div>
                        <div class="bg-green-100 p-3 rounded-full">
                            <i class="fas fa-microchip text-2xl text-green-600"></i>
                        </div>
                    </div>
                </div>

                <!-- Active Sessions -->
                <div class="card bg-white rounded-lg shadow-md p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-500 mb-1">Sessions</p>
                            <p class="text-2xl font-bold text-gray-800">{{ status.active_sessions }}</p>
                        </div>
                        <div class="bg-yellow-100 p-3 rounded-full">
                            <i class="fas fa-users text-2xl text-yellow-600"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Interview Details Lookup -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-search mr-2 text-indigo-600"></i>
                    Interview Details Lookup
                </h2>
                <div class="flex space-x-4">
                    <input v-model="applicationId" 
                           type="text" 
                           placeholder="Enter Application ID (UUID)"
                           class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                           @keyup.enter="fetchInterviewDetails">
                    <button @click="fetchInterviewDetails"
                            :disabled="!applicationId || loading"
                            class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-3 px-8 rounded-lg transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed flex items-center">
                        <i class="fas fa-search mr-2"></i>
                        Lookup
                    </button>
                </div>

                <!-- Interview Details Result -->
                <div v-if="interviewDetails" class="mt-6 p-4 bg-gray-50 rounded-lg">
                    <h3 class="font-semibold text-gray-700 mb-3">Interview Information</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <p class="text-sm text-gray-500">Candidate Name</p>
                            <p class="font-semibold text-gray-800">{{ interviewDetails.candidate_name || 'N/A' }}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Job Title</p>
                            <p class="font-semibold text-gray-800">{{ interviewDetails.job_title || 'N/A' }}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Company</p>
                            <p class="font-semibold text-gray-800">{{ interviewDetails.company_name || 'N/A' }}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Language</p>
                            <p class="font-semibold text-gray-800">{{ interviewDetails.interview_language || 'N/A' }}</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- System Information -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-server mr-2 text-indigo-600"></i>
                    System Information
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <p class="text-sm text-gray-500">Platform</p>
                        <p class="font-semibold text-gray-800">{{ systemInfo.platform }}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">CPU Cores</p>
                        <p class="font-semibold text-gray-800">{{ systemInfo.cpu_count }}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Total Memory</p>
                        <p class="font-semibold text-gray-800">{{ formatMemory(systemInfo.memory_total * 1024) }}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Available Memory</p>
                        <p class="font-semibold text-gray-800">{{ formatMemory(systemInfo.memory_available * 1024) }}</p>
                    </div>
                </div>
            </div>

            <!-- Logs Viewer -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center justify-between">
                    <span>
                        <i class="fas fa-terminal mr-2 text-indigo-600"></i>
                        Logs
                    </span>
                    <div class="flex space-x-2">
                        <button @click="currentLogType = 'combined'"
                                :class="['px-4 py-2 rounded-lg text-sm font-semibold transition', 
                                         currentLogType === 'combined' ? 'bg-indigo-500 text-white' : 'bg-gray-200 text-gray-700']">
                            Combined
                        </button>
                        <button @click="currentLogType = 'out'"
                                :class="['px-4 py-2 rounded-lg text-sm font-semibold transition', 
                                         currentLogType === 'out' ? 'bg-indigo-500 text-white' : 'bg-gray-200 text-gray-700']">
                            Output
                        </button>
                        <button @click="currentLogType = 'error'"
                                :class="['px-4 py-2 rounded-lg text-sm font-semibold transition', 
                                         currentLogType === 'error' ? 'bg-indigo-500 text-white' : 'bg-gray-200 text-gray-700']">
                            Errors
                        </button>
                        <button @click="fetchLogs"
                                class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg text-sm font-semibold transition">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </h2>
                <div class="log-viewer">
                    <div v-if="logs.length === 0" class="text-gray-500">No logs available</div>
                    <div v-for="(line, index) in logs" :key="index">{{ line }}</div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="bg-white mt-8 py-6 text-center text-gray-500 text-sm">
            <p>Rolevate Agent Controller v1.0.0 | Built with FastAPI & Vue.js</p>
        </footer>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    status: {
                        is_running: false,
                        uptime: null,
                        memory_usage: null,
                        cpu_usage: null,
                        active_sessions: 0
                    },
                    systemInfo: {
                        python_version: '',
                        platform: '',
                        memory_total: 0,
                        memory_available: 0,
                        cpu_count: 0
                    },
                    logs: [],
                    currentLogType: 'combined',
                    applicationId: '',
                    interviewDetails: null,
                    loading: false,
                    currentTime: '',
                    ws: null
                };
            },
            mounted() {
                this.refreshStatus();
                this.fetchSystemInfo();
                this.fetchLogs();
                this.updateTime();
                this.connectWebSocket();
                
                // Auto-refresh every 5 seconds
                setInterval(() => {
                    if (!this.ws || this.ws.readyState !== WebSocket.OPEN) {
                        this.refreshStatus();
                    }
                }, 5000);
                
                setInterval(() => {
                    this.updateTime();
                }, 1000);
            },
            watch: {
                currentLogType() {
                    this.fetchLogs();
                }
            },
            methods: {
                async refreshStatus() {
                    try {
                        const response = await fetch('/api/status');
                        this.status = await response.json();
                    } catch (error) {
                        console.error('Error fetching status:', error);
                    }
                },
                async fetchSystemInfo() {
                    try {
                        const response = await fetch('/api/system');
                        this.systemInfo = await response.json();
                    } catch (error) {
                        console.error('Error fetching system info:', error);
                    }
                },
                async fetchLogs() {
                    try {
                        const response = await fetch(`/api/logs/${this.currentLogType}?lines=100`);
                        const data = await response.json();
                        this.logs = data.lines;
                    } catch (error) {
                        console.error('Error fetching logs:', error);
                    }
                },
                async startAgent() {
                    this.loading = true;
                    try {
                        const response = await fetch('/api/agent/start', { method: 'POST' });
                        const data = await response.json();
                        alert(data.message);
                        await this.refreshStatus();
                    } catch (error) {
                        alert('Error starting agent: ' + error.message);
                    } finally {
                        this.loading = false;
                    }
                },
                async stopAgent() {
                    if (!confirm('Are you sure you want to stop the agent?')) return;
                    
                    this.loading = true;
                    try {
                        const response = await fetch('/api/agent/stop', { method: 'POST' });
                        const data = await response.json();
                        alert(data.message);
                        await this.refreshStatus();
                    } catch (error) {
                        alert('Error stopping agent: ' + error.message);
                    } finally {
                        this.loading = false;
                    }
                },
                async restartAgent() {
                    if (!confirm('Are you sure you want to restart the agent?')) return;
                    
                    this.loading = true;
                    try {
                        const response = await fetch('/api/agent/restart', { method: 'POST' });
                        const data = await response.json();
                        alert(data.message);
                        await this.refreshStatus();
                    } catch (error) {
                        alert('Error restarting agent: ' + error.message);
                    } finally {
                        this.loading = false;
                    }
                },
                async fetchInterviewDetails() {
                    if (!this.applicationId) return;
                    
                    this.loading = true;
                    this.interviewDetails = null;
                    
                    try {
                        const response = await fetch('/api/interview/details', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ application_id: this.applicationId })
                        });
                        
                        if (response.ok) {
                            this.interviewDetails = await response.json();
                        } else {
                            const error = await response.json();
                            alert('Error: ' + error.detail);
                        }
                    } catch (error) {
                        alert('Error fetching interview details: ' + error.message);
                    } finally {
                        this.loading = false;
                    }
                },
                connectWebSocket() {
                    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                    const wsUrl = `${protocol}//${window.location.host}/ws`;
                    
                    try {
                        this.ws = new WebSocket(wsUrl);
                        
                        this.ws.onmessage = (event) => {
                            const message = JSON.parse(event.data);
                            if (message.type === 'status_update') {
                                this.status = message.data;
                            }
                        };
                        
                        this.ws.onclose = () => {
                            console.log('WebSocket closed, will retry...');
                            setTimeout(() => this.connectWebSocket(), 5000);
                        };
                    } catch (error) {
                        console.error('WebSocket error:', error);
                    }
                },
                formatUptime(seconds) {
                    if (!seconds) return 'N/A';
                    
                    const hours = Math.floor(seconds / 3600);
                    const minutes = Math.floor((seconds % 3600) / 60);
                    const secs = Math.floor(seconds % 60);
                    
                    if (hours > 0) {
                        return `${hours}h ${minutes}m`;
                    } else if (minutes > 0) {
                        return `${minutes}m ${secs}s`;
                    } else {
                        return `${secs}s`;
                    }
                },
                formatMemory(mb) {
                    if (!mb) return 'N/A';
                    
                    if (mb > 1024) {
                        return `${(mb / 1024).toFixed(2)} GB`;
                    } else {
                        return `${mb.toFixed(2)} MB`;
                    }
                },
                formatCpu(percent) {
                    if (percent === null || percent === undefined) return 'N/A';
                    return `${percent.toFixed(1)}%`;
                },
                updateTime() {
                    const now = new Date();
                    this.currentTime = now.toLocaleString();
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
