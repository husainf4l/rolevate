<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Logout Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        .output { background: #f5f5f5; padding: 10px; margin: 10px 0; }
        .error { color: red; }
        .success { color: green; }
    </style>
</head>
<body>
    <h1>Authentication Logout Test</h1>

    <div class="section">
        <h3>1. Test Login First</h3>
        <input type="email" id="email" placeholder="Email" value="al-hussein@papayatrading.com" style="width: 250px; padding: 5px;">
        <input type="password" id="password" placeholder="Password" value="TT%%oo77" style="width: 250px; padding: 5px;">
        <button onclick="testLogin()">Test Login</button>
        <div id="loginResult" class="output"></div>
    </div>

    <div class="section">
        <h3>2. Check Current State</h3>
        <button onclick="checkCurrentState()">Check Cookies & Storage</button>
        <div id="stateResult" class="output"></div>
    </div>

    <div class="section">
        <h3>3. Test Logout</h3>
        <button onclick="testLogout()">Test Logout</button>
        <div id="logoutResult" class="output"></div>
    </div>

    <div class="section">
        <h3>4. Verify Auth After Logout</h3>
        <button onclick="testVerifyAuth()">Verify Auth Status</button>
        <div id="verifyResult" class="output"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:4005';

        async function testLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const resultDiv = document.getElementById('loginResult');
            
            try {
                resultDiv.innerHTML = '<p>Logging in...</p>';
                
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email, password }),
                });

                console.log('Login response:', response);
                console.log('Login response headers:', Object.fromEntries(response.headers.entries()));
                
                // Check for Set-Cookie headers specifically
                const setCookieHeaders = response.headers.get('set-cookie');
                console.log('Set-Cookie headers:', setCookieHeaders);
                
                // Check all headers that might contain auth info
                const authHeaders = {};
                for (const [key, value] of response.headers.entries()) {
                    if (key.toLowerCase().includes('cookie') || key.toLowerCase().includes('auth') || key.toLowerCase().includes('token')) {
                        authHeaders[key] = value;
                    }
                }
                console.log('Auth-related headers:', authHeaders);

                if (response.ok) {
                    const data = await response.json();
                    resultDiv.innerHTML = `<p class="success">‚úÖ Login successful!</p><pre>${JSON.stringify(data, null, 2)}</pre>`;
                } else {
                    const errorData = await response.text();
                    resultDiv.innerHTML = `<p class="error">‚ùå Login failed: ${response.status}</p><pre>${errorData}</pre>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">‚ùå Network error: ${error.message}</p>`;
                console.error('Login error:', error);
            }
        }

        function checkCurrentState() {
            const resultDiv = document.getElementById('stateResult');
            
            // Check cookies (only non-HttpOnly ones are visible)
            const cookies = document.cookie;
            
            // Check localStorage
            const localStorage_data = {};
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                localStorage_data[key] = localStorage.getItem(key);
            }
            
            // Check sessionStorage
            const sessionStorage_data = {};
            for (let i = 0; i < sessionStorage.length; i++) {
                const key = sessionStorage.key(i);
                sessionStorage_data[key] = sessionStorage.getItem(key);
            }

            resultDiv.innerHTML = `
                <p><strong>‚ö†Ô∏è Note:</strong> HTTP-only cookies (like access_token) are hidden from JavaScript for security</p>
                
                <p><strong>Visible Cookies (non-HttpOnly):</strong></p>
                <pre>${cookies || 'No non-HttpOnly cookies found (this is normal!)'}</pre>
                
                <p><strong>LocalStorage:</strong></p>
                <pre>${JSON.stringify(localStorage_data, null, 2)}</pre>
                
                <p><strong>SessionStorage:</strong></p>
                <pre>${JSON.stringify(sessionStorage_data, null, 2)}</pre>
                
                <p><strong>‚úÖ HTTP-only cookies are working correctly!</strong><br>
                The access_token cookie is secure and can't be accessed by JavaScript.</p>
            `;
        }

        async function testLogout() {
            const resultDiv = document.getElementById('logoutResult');
            
            try {
                resultDiv.innerHTML = '<p>Testing logout...</p>';
                
                // Show state before logout
                const cookiesBefore = document.cookie;
                console.log('Cookies before logout:', cookiesBefore);
                
                const response = await fetch(`${API_BASE}/auth/logout`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({}),
                });

                console.log('Logout response:', response);
                console.log('Logout response status:', response.status);
                console.log('Logout response headers:', Object.fromEntries(response.headers.entries()));
                
                // Check for Set-Cookie headers in logout
                const setCookieHeaders = response.headers.get('set-cookie');
                console.log('Logout Set-Cookie headers:', setCookieHeaders);

                if (response.ok) {
                    const data = await response.json();
                    
                    // Show state after logout
                    const cookiesAfter = document.cookie;
                    console.log('Cookies after logout:', cookiesAfter);
                    
                    resultDiv.innerHTML = `
                        <p class="success">‚úÖ Logout API call successful!</p>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                        
                        <p><strong>‚ö†Ô∏è Note:</strong> HTTP-only cookies aren't visible to JavaScript</p>
                        <p><strong>‚úÖ Check:</strong> The server should have cleared the access_token cookie</p>
                        
                        <p><strong>Next step:</strong> Test verify endpoint to confirm session is destroyed</p>
                    `;
                } else {
                    const errorData = await response.text();
                    resultDiv.innerHTML = `<p class="error">‚ùå Logout failed: ${response.status}</p><pre>${errorData}</pre>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">‚ùå Logout error: ${error.message}</p>`;
                console.error('Logout error:', error);
            }
        }

        async function testVerifyAuth() {
            const resultDiv = document.getElementById('verifyResult');
            
            try {
                resultDiv.innerHTML = '<p>Verifying auth status...</p>';
                
                // Add cache busting to prevent cached responses
                const response = await fetch(`${API_BASE}/auth/verify?cb=${Date.now()}`, {
                    method: 'GET',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache, no-store, must-revalidate'
                    },
                });

                console.log('Verify response:', response);
                console.log('Verify response headers:', Object.fromEntries(response.headers.entries()));

                if (response.ok) {
                    const data = await response.json();
                    if (data.authenticated) {
                        resultDiv.innerHTML = `
                            <p class="error">‚ùå Still authenticated (logout didn't work)</p>
                            <p><strong>üêõ COOKIE PATH BUG CONFIRMED:</strong></p>
                            <p>Backend sets cookies on <code>path=/</code> but tries to clear them on <code>path=/auth/</code></p>
                            <p>This prevents proper logout because cookie paths must match exactly.</p>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        `;
                    } else {
                        resultDiv.innerHTML = `<p class="success">‚úÖ Not authenticated (logout worked!)</p><pre>${JSON.stringify(data, null, 2)}</pre>`;
                    }
                } else {
                    const errorData = await response.text();
                    resultDiv.innerHTML = `<p class="success">‚úÖ Not authenticated (logout worked!)</p><pre>Status: ${response.status}<br>${errorData}</pre>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">‚ùå Network error: ${error.message}</p>`;
                console.error('Verify auth error:', error);
            }
        }

        // Auto-check state on page load
        window.onload = function() {
            checkCurrentState();
        };
    </script>
</body>
</html>